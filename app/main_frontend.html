<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lebensessenz Kursbot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f1ed;
      min-height: 100vh;
      display: flex;
      line-height: 1.6;
      overflow: hidden;
      padding: 20px;
    }

    .app-container {
      display: flex;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      gap: 20px;
      height: calc(100vh - 40px);
    }

    /* Sidebar - Floating Design */
    .sidebar {
      width: 280px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 24px 20px 20px 20px;
      border-bottom: 1px solid #e5e5e5;
    }

    .sidebar-header h2 {
      font-size: 1.25rem;
      color: #1a1a1a;
      margin-bottom: 16px;
      font-weight: 500;
      letter-spacing: -0.3px;
    }

    .new-chat-btn {
      width: 100%;
      padding: 14px 16px;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(201, 168, 151, 0.3);
    }

    .new-chat-btn:hover {
      background: #b89786;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(201, 168, 151, 0.4);
    }

    .new-chat-btn:active {
      transform: translateY(0);
    }

    .conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .conversation-list::-webkit-scrollbar {
      width: 6px;
    }

    .conversation-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .conversation-list::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 3px;
    }

    .conversation-list::-webkit-scrollbar-thumb:hover {
      background: #d0d0d0;
    }

    .conversation-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .conversation-item:hover {
      background: #f5f1ed;
    }

    .conversation-item.active {
      background: #f5f1ed;
      border-color: #c9a897;
    }

    .conversation-title {
      font-size: 14px;
      color: #1a1a1a;
      font-weight: 500;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation-date {
      font-size: 12px;
      color: #999;
    }

    .empty-conversations {
      padding: 40px 20px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }

    /* Main Chat Area - Floating Design */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      animation: slideUp 0.5s ease-out;
      position: relative;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-header {
      padding: 24px 32px;
      border-bottom: 1px solid #e5e5e5;
    }

    .chat-header h1 {
      font-size: 1.5rem;
      color: #1a1a1a;
      font-weight: 500;
      letter-spacing: -0.5px;
      margin-bottom: 4px;
    }

    .chat-header .subtitle {
      color: #666;
      font-size: 0.875rem;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
    }

    .chat-history::-webkit-scrollbar {
      width: 8px;
    }

    .chat-history::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-history::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 4px;
    }

    .chat-history::-webkit-scrollbar-thumb:hover {
      background: #d0d0d0;
    }

    .message {
      margin-bottom: 28px;
      animation: messageSlide 0.4s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-role {
      font-weight: 600;
      margin-bottom: 10px;
      color: #c9a897;
      font-size: 0.813rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .message.assistant .message-role {
      color: #1a1a1a;
    }

    .message-content {
      color: #1a1a1a;
      line-height: 1.75;
      word-wrap: break-word;
      font-size: 15px;
      white-space: pre-wrap;
    }

    .message-content p {
      margin-bottom: 12px;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    .message.assistant .message-content {
      background: #f5f1ed;
      padding: 20px 24px;
      border-radius: 14px;
    }

    .message-content strong {
      font-weight: 600;
      color: #1a1a1a;
    }

    .message-content h1,
    .message-content h2,
    .message-content h3 {
      margin: 20px 0 12px 0;
      line-height: 1.4;
      font-weight: 600;
    }

    .message-content h1 { font-size: 1.5rem; }
    .message-content h2 { font-size: 1.25rem; }
    .message-content h3 { font-size: 1.125rem; }

    .message-content h1:first-child,
    .message-content h2:first-child,
    .message-content h3:first-child {
      margin-top: 0;
    }

    /* Sources Accordion */
    .sources-accordion {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e0d7d0;
    }

    .sources-accordion details {
      cursor: pointer;
      user-select: none;
    }

    .sources-accordion summary {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      margin: -12px -16px 0 -16px;
      font-weight: 600;
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      background: #f9f7f5;
    }

    .sources-accordion summary:hover {
      background: #f5f1ed;
    }

    .sources-accordion details[open] summary {
      background: #f5f1ed;
      margin-bottom: 12px;
    }

    .sources-accordion summary::before {
      content: 'â–¶';
      display: inline-flex;
      width: 16px;
      transition: transform 0.3s ease;
      transform: rotate(0deg);
      font-size: 12px;
      color: #c9a897;
    }

    .sources-accordion details[open] summary::before {
      transform: rotate(90deg);
    }

    .sources-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 0 16px 12px 16px;
      margin: 0 -16px -12px -16px;
    }

    .source-tag {
      display: inline-block;
      background: white;
      padding: 8px 14px;
      border-radius: 18px;
      font-size: 13px;
      color: #c9a897;
      border: 1px solid #e5e5e5;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .source-tag:hover {
      border-color: #c9a897;
      background: #faf8f6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(201, 168, 151, 0.2);
    }

    .input-container {
      padding: 24px 32px;
      border-top: 1px solid #e5e5e5;
      background: #fafafa;
    }

    .input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .upload-btn {
      width: 44px;
      height: 44px;
      padding: 0;
      background: #e8dfd8;
      color: #666;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .upload-btn:hover {
      background: #ddd3cc;
      transform: scale(1.05);
    }

    .upload-btn:active {
      transform: scale(0.95);
    }

    .upload-btn svg {
      width: 20px;
      height: 20px;
    }

    .image-preview {
      display: none;
      position: relative;
      width: fit-content;
      max-width: 200px;
    }

    .image-preview.show {
      display: block;
    }

    .image-preview img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 12px;
      border: 2px solid #e5e5e5;
      object-fit: cover;
    }

    .image-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .image-preview-remove:hover {
      background: #b89786;
      transform: scale(1.1);
    }

    /* Drag & Drop Overlay */
    .drag-drop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(201, 168, 151, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
      border-radius: 16px;
    }

    .drag-drop-overlay.active {
      display: flex;
    }

    .drag-drop-content {
      text-align: center;
      color: white;
      pointer-events: none;
    }

    .drag-drop-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .drag-drop-text {
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .drag-drop-subtext {
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Image in message */
    .message-image {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      max-width: 400px;
    }

    .message-image img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      border: 2px solid #e5e5e5;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message-image img:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .message.user .message-image img {
      border-color: #c9a897;
    }

    /* Bot Thinking Animation */
    .message.thinking {
      animation: fadeIn 0.4s ease-out;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .thinking-indicator {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 20px 24px;
      background: linear-gradient(135deg, #f5f1ed 0%, #faf8f6 100%);
      border-radius: 12px;
      border: 1px solid #e8dfd8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .thinking-text {
      font-size: 14px;
      color: #666;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .thinking-dots {
      display: flex;
      align-items: center;
      gap: 6px;
      height: 20px;
    }

    .thinking-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #c9a897 0%, #b89786 100%);
      animation: thinkingPulse 1.4s ease-in-out infinite;
      box-shadow: 0 2px 4px rgba(201, 168, 151, 0.3);
    }

    .thinking-dot:nth-child(1) {
      animation-delay: 0s;
    }

    .thinking-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes thinkingPulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.3);
        opacity: 1;
      }
    }

    /* Subtle shimmer effect */
    .thinking-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite;
    }

    .thinking-indicator {
      position: relative;
      overflow: hidden;
    }

    @keyframes shimmer {
      0% {
        left: -100%;
      }
      100% {
        left: 200%;
      }
    }

    textarea {
      flex: 1;
      min-height: 72px;
      max-height: 180px;
      padding: 18px 20px;
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      font-family: inherit;
      font-size: 15px;
      line-height: 1.5;
      resize: none;
      transition: all 0.3s ease;
      background: white;
      color: #1a1a1a;
    }

    textarea:focus {
      outline: none;
      border-color: #c9a897;
      box-shadow: 0 0 0 3px rgba(201, 168, 151, 0.1);
    }

    textarea::placeholder {
      color: #aaa;
    }

    .send-btn {
      width: 44px;
      height: 44px;
      padding: 0;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(201, 168, 151, 0.3);
      flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
      background: #b89786;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(201, 168, 151, 0.4);
    }

    .send-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-btn svg {
      width: 20px;
      height: 20px;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      font-size: 3.5rem;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .empty-state-text {
      font-size: 1.25rem;
      margin-bottom: 10px;
      color: #666;
      font-weight: 500;
    }

    .empty-state-subtext {
      font-size: 0.938rem;
      color: #999;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .app-container {
        gap: 10px;
        height: calc(100vh - 20px);
      }

      .sidebar {
        position: fixed;
        left: 10px;
        top: 10px;
        height: calc(100vh - 20px);
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .chat-header, .chat-history, .input-container {
        padding-left: 20px;
        padding-right: 20px;
      }

      .input-container {
        padding-top: 16px;
        padding-bottom: 16px;
      }

      .send-btn {
        padding: 18px 24px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Lebensessenz</h2>
        <button class="new-chat-btn" onclick="newChat()">+ Neuer Chat</button>
      </div>
      <div class="conversation-list" id="conversationList">
        <div class="empty-conversations">Keine Conversations vorhanden</div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-area" id="mainArea">
      <!-- Drag & Drop Overlay -->
      <div class="drag-drop-overlay" id="dragDropOverlay">
        <div class="drag-drop-content">
          <div class="drag-drop-icon">ðŸ“¸</div>
          <div class="drag-drop-text">Bild hier ablegen</div>
          <div class="drag-drop-subtext">JPG, PNG, HEIC oder WebP</div>
        </div>
      </div>

      <div class="chat-header">
        <h1>Kursbot</h1>
        <p class="subtitle">Stelle deine Fragen zum Kursmaterial</p>
      </div>

      <div class="chat-history" id="chatHistory">
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ’¬</div>
          <div class="empty-state-text">Starte eine Konversation</div>
          <div class="empty-state-subtext">Stelle eine Frage zum Kursmaterial</div>
        </div>
      </div>

      <div class="input-container">
        <div class="input-wrapper">
          <!-- Image Preview -->
          <div class="image-preview" id="imagePreview">
            <img id="previewImg" src="" alt="Preview">
            <button class="image-preview-remove" onclick="removeImage()" title="Bild entfernen">Ã—</button>
          </div>

          <!-- Input Group -->
          <div class="input-group">
            <input type="file" id="imageInput" accept="image/jpeg,image/jpg,image/png,image/heic,image/webp" style="display: none;" onchange="handleImageSelect(event)">
            <button class="upload-btn" onclick="document.getElementById('imageInput').click()" title="Bild hochladen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"/>
              </svg>
            </button>
            <textarea
              id="messageInput"
              placeholder="Stelle eine Frage oder lade ein Foto hoch..."
              onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Senden">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19V5M5 12l7-7 7 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// State
let guestId = localStorage.getItem('guestId');
let conversationId = null;
let conversations = [];
let selectedImage = null;
let selectedImageDataUrl = null; // For displaying in chat

// Initialize guest ID
if (!guestId) {
  guestId = generateUUID();
  localStorage.setItem('guestId', guestId);
  console.log('Generated new guest ID:', guestId);
}

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Drag & Drop Handlers
function initDragAndDrop() {
  const mainArea = document.getElementById('mainArea');
  const overlay = document.getElementById('dragDropOverlay');
  let dragCounter = 0;

  // Prevent default drag behaviors on whole document
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    document.body.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // Highlight drop area when dragging over main area
  mainArea.addEventListener('dragenter', (e) => {
    dragCounter++;
    if (e.dataTransfer.types.includes('Files')) {
      overlay.classList.add('active');
    }
  });

  mainArea.addEventListener('dragleave', (e) => {
    dragCounter--;
    if (dragCounter === 0) {
      overlay.classList.remove('active');
    }
  });

  mainArea.addEventListener('dragover', (e) => {
    if (e.dataTransfer.types.includes('Files')) {
      e.dataTransfer.dropEffect = 'copy';
    }
  });

  mainArea.addEventListener('drop', (e) => {
    dragCounter = 0;
    overlay.classList.remove('active');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleDroppedFile(files[0]);
    }
  });
}

function handleDroppedFile(file) {
  // Validate file type
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/heic', 'image/webp'];
  if (!validTypes.includes(file.type)) {
    alert('Bitte wÃ¤hle ein gÃ¼ltiges Bildformat (JPG, PNG, HEIC, WebP)');
    return;
  }

  // Validate file size (10MB max)
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    alert('Bild ist zu groÃŸ. Maximale GrÃ¶ÃŸe: 10MB');
    return;
  }

  selectedImage = file;

  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    selectedImageDataUrl = e.target.result;
    const previewDiv = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    previewImg.src = selectedImageDataUrl;
    previewDiv.classList.add('show');
  };
  reader.readAsDataURL(file);

  // Update placeholder and focus
  document.getElementById('messageInput').placeholder = 'Beschreibe deine Frage zum Bild...';
  document.getElementById('messageInput').focus();
}

function formatSource(source) {
  /**
   * Format source with professional module metadata display.
   *
   * New format: "Modul 1 (1.2 FrÃ¼hstÃ¼ck und richtiger Obstverzehr), Seite 3"
   * Fallback: Parse from path if metadata missing
   */

  // Use rich metadata if available
  if (source.module_label && source.submodule_id && source.submodule_label) {
    let result = source.module_label;

    // Add submodule info in parentheses
    result += ` (${source.submodule_id} ${source.submodule_label})`;

    // Add page number
    if (source.page) {
      result += `, Seite ${source.page}`;
    }

    return result;
  }

  // Fallback: Parse from path (legacy or if metadata missing)
  const path = source.path || source;
  const parts = path.split('/');
  let result = '';

  if (parts[0] && parts[0].startsWith('modul-')) {
    const modulMatch = parts[0].match(/modul-(\d+)\.(\d+)/);
    if (modulMatch) {
      result = `Modul ${modulMatch[1]} (${modulMatch[1]}.${modulMatch[2]})`;
    } else {
      const modulNum = parts[0].match(/modul-(\d+)/);
      if (modulNum) {
        result = `Modul ${modulNum[1]}`;
      }
    }
  }

  if (parts[1]) {
    const pageMatch = parts[1].match(/page-(\d+)/);
    if (pageMatch) {
      const pageNum = parseInt(pageMatch[1], 10);
      result += ` - Seite ${pageNum}`;
    }
  }

  return result || path;
}

function formatMarkdown(text) {
  // Convert Markdown to HTML with proper line breaks
  let html = text;

  // Convert ### Heading to <h3>
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');

  // Convert ## Heading to <h2>
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

  // Convert # Heading to <h1>
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Convert **bold** to <strong>
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

  // Convert double line breaks to paragraphs
  html = html.split('\n\n').map(para => {
    para = para.trim();
    if (!para) return '';
    // Don't wrap headings in <p>
    if (para.startsWith('<h')) return para;
    return '<p>' + para + '</p>';
  }).join('\n');

  return html;
}

function formatDate(isoString) {
  const date = new Date(isoString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Gerade eben';
  if (diffMins < 60) return `Vor ${diffMins}min`;
  if (diffHours < 24) return `Vor ${diffHours}h`;
  if (diffDays < 7) return `Vor ${diffDays}d`;

  return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
}

async function loadConversations() {
  try {
    const response = await fetch(`/conversations?guest_id=${guestId}`);
    const data = await response.json();
    conversations = data.conversations || [];
    renderConversationList();
  } catch (error) {
    console.error('Failed to load conversations:', error);
  }
}

function renderConversationList() {
  const listEl = document.getElementById('conversationList');

  if (conversations.length === 0) {
    listEl.innerHTML = '<div class="empty-conversations">Keine Conversations vorhanden</div>';
    return;
  }

  listEl.innerHTML = conversations.map(conv => `
    <div class="conversation-item ${conv.id === conversationId ? 'active' : ''}"
         onclick="loadConversation('${conv.id}')">
      <div class="conversation-title">${escapeHtml(conv.title || 'Neue Conversation')}</div>
      <div class="conversation-date">${formatDate(conv.updated_at)}</div>
    </div>
  `).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function loadConversation(convId) {
  conversationId = convId;
  renderConversationList(); // Update active state

  try {
    const response = await fetch(`/conversations/${convId}/messages?guest_id=${guestId}`);
    const data = await response.json();

    const chatHistory = document.getElementById('chatHistory');
    chatHistory.innerHTML = '';

    for (const msg of data.messages) {
      // Convert image_path to URL if present
      let imageUrl = null;
      if (msg.image_path) {
        // Extract filename from path (e.g., "storage/uploads/abc123.jpg" -> "abc123.jpg")
        const filename = msg.image_path.split('/').pop();
        imageUrl = `/uploads/${filename}`;
      }
      renderMessage(msg.role, msg.content, null, imageUrl);
    }
  } catch (error) {
    console.error('Failed to load conversation:', error);
  }
}

function showThinkingIndicator() {
  const chatHistory = document.getElementById('chatHistory');
  const emptyState = chatHistory.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }

  const thinkingDiv = document.createElement('div');
  thinkingDiv.className = 'message assistant thinking';
  thinkingDiv.id = 'thinkingIndicator';

  thinkingDiv.innerHTML = `
    <div class="message-role">Kursbot</div>
    <div class="thinking-indicator">
      <span class="thinking-text">Denkt nach</span>
      <div class="thinking-dots">
        <div class="thinking-dot"></div>
        <div class="thinking-dot"></div>
        <div class="thinking-dot"></div>
      </div>
    </div>
  `;

  chatHistory.appendChild(thinkingDiv);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function removeThinkingIndicator() {
  const thinkingIndicator = document.getElementById('thinkingIndicator');
  if (thinkingIndicator) {
    thinkingIndicator.style.opacity = '0';
    thinkingIndicator.style.transform = 'translateY(-10px)';
    setTimeout(() => thinkingIndicator.remove(), 300);
  }
}

function renderMessage(role, content, sources = null, imageUrl = null) {
  const chatHistory = document.getElementById('chatHistory');
  const emptyState = chatHistory.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }

  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;

  const roleLabel = role === 'user' ? 'Du' : 'Kursbot';
  const formattedContent = role === 'assistant' ? formatMarkdown(content) : escapeHtml(content);

  let html = `
    <div class="message-role">${roleLabel}</div>
    <div class="message-content">${formattedContent}</div>
  `;

  // Add image if provided
  if (imageUrl) {
    html += `
      <div class="message-image">
        <img src="${imageUrl}" alt="Hochgeladenes Bild" onclick="window.open('${imageUrl}', '_blank')">
      </div>
    `;
  }

  if (sources && sources.length > 0) {
    const sourceTags = sources
      .map(s => `<span class="source-tag" title="${escapeHtml(formatSource(s))}">${escapeHtml(formatSource(s))}</span>`)
      .join('');
    html += `
      <div class="sources-accordion">
        <details>
          <summary>${sources.length} Quelle${sources.length > 1 ? 'n' : ''}</summary>
          <div class="sources-container">
            ${sourceTags}
          </div>
        </details>
      </div>
    `;
  }

  messageDiv.innerHTML = html;
  chatHistory.appendChild(messageDiv);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function handleImageSelect(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Validate file type
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/heic', 'image/webp'];
  if (!validTypes.includes(file.type)) {
    alert('Bitte wÃ¤hle ein gÃ¼ltiges Bildformat (JPG, PNG, HEIC, WebP)');
    return;
  }

  // Validate file size (10MB max)
  const maxSize = 10 * 1024 * 1024; // 10MB
  if (file.size > maxSize) {
    alert('Bild ist zu groÃŸ. Maximale GrÃ¶ÃŸe: 10MB');
    return;
  }

  selectedImage = file;

  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    selectedImageDataUrl = e.target.result;
    const previewDiv = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    previewImg.src = selectedImageDataUrl;
    previewDiv.classList.add('show');
  };
  reader.readAsDataURL(file);

  // Update placeholder
  document.getElementById('messageInput').placeholder = 'Beschreibe deine Frage zum Bild...';
}

function removeImage() {
  selectedImage = null;
  selectedImageDataUrl = null;
  document.getElementById('imageInput').value = '';
  document.getElementById('imagePreview').classList.remove('show');
  document.getElementById('messageInput').placeholder = 'Stelle eine Frage oder lade ein Foto hoch...';
}

async function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();

  if (!message && !selectedImage) return;

  const sendBtn = document.getElementById('sendBtn');
  const sendBtnText = document.getElementById('sendBtnText');

  // Disable input and show loading spinner in button
  input.disabled = true;
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<div class="spinner"></div>';

  // Store image refs and clear for next message
  const imageToSend = selectedImage;
  const imageDataUrl = selectedImageDataUrl;

  // Render user message immediately (with image if present)
  renderMessage('user', message, null, imageDataUrl);
  input.value = '';

  if (selectedImage) {
    removeImage();
  }

  // Show thinking indicator
  showThinkingIndicator();

  try {
    let response;

    if (imageToSend) {
      // Use multipart form data for image upload
      const formData = new FormData();
      formData.append('message', message || 'Was siehst du auf diesem Bild?');
      if (conversationId) formData.append('conversationId', conversationId);
      if (guestId) formData.append('guestId', guestId);
      formData.append('image', imageToSend);

      response = await fetch('/chat/image', {
        method: 'POST',
        body: formData
      });
    } else {
      // Use JSON for regular text chat
      response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          conversationId: conversationId,
          message: message,
          guestId: guestId
        })
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.detail || 'Server error');
    }

    const data = await response.json();

    // Remove thinking indicator before showing response
    removeThinkingIndicator();

    // Small delay to let the fade-out animation complete
    await new Promise(resolve => setTimeout(resolve, 350));

    // Update conversation ID if new
    if (!conversationId) {
      conversationId = data.conversationId;
      await loadConversations(); // Refresh sidebar
    }

    // Render assistant message
    renderMessage('assistant', data.answer, data.sources);

    // Refresh conversations to update timestamp
    await loadConversations();

  } catch (error) {
    console.error('Error:', error);
    removeThinkingIndicator();
    await new Promise(resolve => setTimeout(resolve, 350));
    renderMessage('assistant', 'Fehler beim Abrufen der Antwort. Bitte versuche es erneut.');
  } finally {
    input.disabled = false;
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>';
    input.focus();
  }
}

function newChat() {
  conversationId = null;

  const chatHistory = document.getElementById('chatHistory');
  chatHistory.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ’¬</div>
      <div class="empty-state-text">Starte eine Konversation</div>
      <div class="empty-state-subtext">Stelle eine Frage zum Kursmaterial</div>
    </div>
  `;

  renderConversationList(); // Update active state
  document.getElementById('messageInput').focus();
}

// Load conversations on page load
window.addEventListener('DOMContentLoaded', async () => {
  // Initialize drag and drop
  initDragAndDrop();

  await loadConversations();

  // Check for conversation ID in URL
  const urlParams = new URLSearchParams(window.location.search);
  const urlConvId = urlParams.get('c');
  if (urlConvId && conversations.some(c => c.id === urlConvId)) {
    await loadConversation(urlConvId);
  }

  document.getElementById('messageInput').focus();
});
</script>
</body>
</html>
