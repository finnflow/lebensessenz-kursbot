<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#f5f1ed"/>
  <title>Lebensessenz Kursbot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f1ed;
      min-height: 100vh;
      min-height: 100dvh; /* Dynamic viewport height for mobile */
      display: flex;
      line-height: 1.6;
      overflow: hidden;
      padding: 20px;
    }

    /* Accessibility - Focus States for Keyboard Navigation */
    button:focus-visible,
    a:focus-visible,
    [role="button"]:focus-visible {
      outline: 2px solid #c9a897;
      outline-offset: 2px;
    }

    .app-container {
      display: flex;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      gap: 20px;
      height: calc(100vh - 40px);
    }

    /* Safe area support for notch/camera cutout */
    @supports (padding: max(0px)) {
      .chat-header {
        padding-top: max(24px, env(safe-area-inset-top));
      }

      .input-container {
        padding-bottom: max(24px, env(safe-area-inset-bottom));
      }
    }

    /* Sidebar - Floating Design with Collapse */
    .sidebar {
      width: 280px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 10; /* Above main content, below modals */
    }

    .sidebar.collapsed {
      width: 60px;
    }

    .sidebar-header {
      padding: 24px 20px 20px 20px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .sidebar.collapsed .sidebar-header {
      padding: 16px 8px;
      flex-direction: column;
    }

    .sidebar-header h2 {
      font-size: 1.25rem;
      color: #1a1a1a;
      margin-bottom: 16px;
      font-weight: 500;
      letter-spacing: -0.3px;
      margin: 0;
      flex: 1;
    }

    .sidebar.collapsed .sidebar-header h2 {
      display: none;
    }

    .sidebar-toggle-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      background: transparent;
      color: #c9a897;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
      position: relative;
      z-index: 10000;
      overflow: visible;
    }

    .sidebar-toggle-btn:hover {
      background: #f5f1ed;
      transform: scale(1.05);
    }

    .sidebar-toggle-btn:active {
      transform: scale(0.95);
    }

    .sidebar-toggle-btn svg {
      transition: transform 0.3s ease;
    }

    .new-chat-btn {
      width: 100%;
      padding: 14px 16px;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(201, 168, 151, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .new-chat-btn:hover {
      background: #b89786;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(201, 168, 151, 0.4);
    }

    .new-chat-btn:active {
      transform: translateY(0);
    }

    .new-chat-btn-collapsed {
      width: 44px;
      height: 44px;
      padding: 0;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(201, 168, 151, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: visible;
      z-index: 10000;
    }

    .new-chat-btn-collapsed:hover {
      background: #b89786;
      transform: scale(1.15);
      box-shadow: 0 6px 20px rgba(201, 168, 151, 0.5);
    }

    .new-chat-btn-collapsed:hover svg {
      transform: rotate(90deg);
    }

    .new-chat-btn-collapsed svg {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes tooltipFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes tooltipFadeInFromBottom {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes tooltipFadeInFromLeft {
      from {
        opacity: 0;
        transform: translateY(-50%) translateX(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
      }
    }

    .new-chat-btn-collapsed:active {
      transform: scale(1.05) rotate(90deg);
    }

    .conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .sidebar.collapsed .conversation-list {
      display: none;
    }

    .conversation-list::-webkit-scrollbar {
      width: 6px;
    }

    .conversation-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .conversation-list::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 3px;
    }

    .conversation-list::-webkit-scrollbar-thumb:hover {
      background: #d0d0d0;
    }

    .conversation-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      group: hover;
    }

    .conversation-item:hover {
      background: #f5f1ed;
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .conversation-item.active {
      background: #f5f1ed;
      border-color: #c9a897;
      box-shadow: 0 2px 12px rgba(201, 168, 151, 0.2);
    }

    .conversation-item.active:hover {
      transform: translateX(2px);
    }

    .conversation-content {
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }

    .sidebar.collapsed .conversation-content {
      display: none;
    }

    .conversation-title {
      font-size: 14px;
      color: #1a1a1a;
      font-weight: 500;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation-date {
      font-size: 12px;
      color: #999;
    }

    .conversation-delete-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      background: transparent;
      color: #c9a897;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s ease;
      flex-shrink: 0;
      position: relative;
      z-index: 10000;
      overflow: visible;
    }

    .conversation-delete-btn svg {
      display: block;
    }

    .conversation-item:hover .conversation-delete-btn {
      opacity: 1;
    }

    .conversation-delete-btn:hover {
      background: #f5f1ed;
      color: #b89786;
      transform: scale(1.1);
    }

    .conversation-delete-btn:active {
      transform: scale(0.95);
    }

    .sidebar.collapsed .conversation-delete-btn {
      opacity: 1;
    }

    .empty-conversations {
      padding: 40px 20px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }

    /* Sidebar Footer - Delete All Button */
    .sidebar-footer {
      padding: 12px 8px;
      border-top: 1px solid #e5e5e5;
      margin-top: auto;
    }

    .sidebar.collapsed .sidebar-footer {
      display: none !important;
    }

    .delete-all-btn {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      color: #999;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .delete-all-btn:hover {
      background: #fff0f0;
      border-color: #ff6b6b;
      color: #ff6b6b;
      transform: translateY(-1px);
    }

    .delete-all-btn:active {
      transform: translateY(0);
    }

    .delete-all-btn svg {
      flex-shrink: 0;
    }

    /* Main Chat Area - Floating Design */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      animation: slideUp 0.5s ease-out;
      position: relative;
      z-index: 1; /* Below sidebar and backdrop on mobile */
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-header {
      padding: 24px 32px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .mobile-menu-btn {
      display: none;
      width: 44px;
      height: 44px;
      padding: 0;
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s ease;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .mobile-menu-btn:hover {
      background: #f5f1ed;
      color: #c9a897;
    }

    .mobile-menu-btn:active {
      transform: scale(0.95);
    }

    .chat-header-content {
      flex: 1;
      min-width: 0;
    }

    .chat-header h1 {
      font-size: 1.5rem;
      color: #1a1a1a;
      font-weight: 500;
      letter-spacing: -0.5px;
      margin-bottom: 4px;
    }

    .chat-header .subtitle {
      color: #666;
      font-size: 0.875rem;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
    }

    .chat-history::-webkit-scrollbar {
      width: 8px;
    }

    .chat-history::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-history::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 4px;
    }

    .chat-history::-webkit-scrollbar-thumb:hover {
      background: #d0d0d0;
    }

    .message {
      margin-bottom: 28px;
      animation: messageSlide 0.4s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-role {
      font-weight: 600;
      margin-bottom: 10px;
      color: #c9a897;
      font-size: 0.813rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .message.assistant .message-role {
      color: #1a1a1a;
    }

    .message-content {
      color: #1a1a1a;
      line-height: 1.8;
      word-wrap: break-word;
      font-size: 15px;
      white-space: pre-wrap;
      letter-spacing: 0.01em;
    }

    .message-content p {
      margin-bottom: 12px;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    .message.assistant .message-content {
      background: white;
      padding: 20px 24px;
      border-radius: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.06);
    }

    .message-content strong {
      font-weight: 600;
      color: #1a1a1a;
    }

    .message-content h1,
    .message-content h2,
    .message-content h3 {
      margin: 20px 0 12px 0;
      line-height: 1.4;
      font-weight: 600;
    }

    .message-content h1 { font-size: 1.5rem; }
    .message-content h2 { font-size: 1.25rem; }
    .message-content h3 { font-size: 1.125rem; }

    .message-content h1:first-child,
    .message-content h2:first-child,
    .message-content h3:first-child {
      margin-top: 0;
    }

    /* Sources Accordion */
    .sources-accordion {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e0d7d0;
    }

    .sources-accordion details {
      cursor: pointer;
      user-select: none;
    }

    .sources-accordion summary {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      margin: -12px -16px 0 -16px;
      font-weight: 600;
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      background: #f9f7f5;
    }

    .sources-accordion summary:hover {
      background: #f5f1ed;
    }

    .sources-accordion details[open] summary {
      background: #f5f1ed;
      margin-bottom: 12px;
    }

    .sources-accordion summary::before {
      content: '‚ñ∂';
      display: inline-flex;
      width: 16px;
      transition: transform 0.3s ease;
      transform: rotate(0deg);
      font-size: 12px;
      color: #c9a897;
    }

    .sources-accordion details[open] summary::before {
      transform: rotate(90deg);
    }

    .sources-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 0 16px 12px 16px;
      margin: 0 -16px -12px -16px;
    }

    .source-tag {
      display: inline-block;
      background: white;
      padding: 8px 14px;
      border-radius: 18px;
      font-size: 13px;
      color: #c9a897;
      border: 1px solid #e5e5e5;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .source-tag:hover {
      border-color: #c9a897;
      background: #faf8f6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(201, 168, 151, 0.2);
    }

    .input-container {
      padding: 24px 32px;
      border-top: 1px solid #e5e5e5;
      background: #fafafa;
    }

    .input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .upload-btn {
      width: 66px;
      height: 66px;
      padding: 0;
      background: #e8dfd8;
      color: #666;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-right: 5px;
      position: relative;
      z-index: 10000;
      overflow: visible;
    }

    .upload-btn:hover {
      background: #ddd3cc;
      transform: scale(1.05);
    }

    .upload-btn:active {
      transform: scale(0.95);
    }

    .upload-btn:focus-visible {
      outline: 3px solid #c9a897;
      outline-offset: 3px;
    }

    .upload-btn svg {
      width: 30px;
      height: 30px;
    }

    .upload-btn:hover::after {
      content: attr(title);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
      animation: tooltipFadeInFromBottom 0.2s ease-out;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      z-index: 10001;
    }

    .image-preview {
      display: none;
      position: relative;
      width: fit-content;
      max-width: 200px;
    }

    .image-preview.show {
      display: block;
    }

    .image-preview img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 12px;
      border: 2px solid #e5e5e5;
      object-fit: cover;
    }

    .image-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .image-preview-remove:hover {
      background: #b89786;
      transform: scale(1.1);
    }

    /* Drag & Drop Overlay */
    .drag-drop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(201, 168, 151, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
      border-radius: 16px;
    }

    .drag-drop-overlay.active {
      display: flex;
    }

    .drag-drop-content {
      text-align: center;
      color: white;
      pointer-events: none;
    }

    .drag-drop-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .drag-drop-text {
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .drag-drop-subtext {
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Image in message */
    .message-image {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      max-width: 400px;
    }

    .message-image img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      border: 2px solid #e5e5e5;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message-image img:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .message.user .message-image img {
      border-color: #c9a897;
    }

    /* Bot Thinking Animation */
    .message.thinking {
      animation: fadeIn 0.4s ease-out;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .thinking-indicator {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 20px 24px;
      background: linear-gradient(135deg, #f5f1ed 0%, #faf8f6 100%);
      border-radius: 12px;
      border: 1px solid #e8dfd8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .thinking-text {
      font-size: 14px;
      color: #666;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .thinking-dots {
      display: flex;
      align-items: center;
      gap: 6px;
      height: 20px;
    }

    .thinking-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #c9a897 0%, #b89786 100%);
      animation: thinkingPulse 1.4s ease-in-out infinite;
      box-shadow: 0 2px 4px rgba(201, 168, 151, 0.3);
    }

    .thinking-dot:nth-child(1) {
      animation-delay: 0s;
    }

    .thinking-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes thinkingPulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.3);
        opacity: 1;
      }
    }

    /* Subtle shimmer effect */
    .thinking-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite;
    }

    .thinking-indicator {
      position: relative;
      overflow: hidden;
    }

    @keyframes shimmer {
      0% {
        left: -100%;
      }
      100% {
        left: 200%;
      }
    }

    textarea {
      flex: 1;
      min-height: 72px;
      max-height: 180px;
      padding: 18px 20px;
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      font-family: inherit;
      font-size: 15px;
      line-height: 1.5;
      resize: none;
      transition: all 0.3s ease;
      background: white;
      color: #1a1a1a;
    }

    textarea:focus {
      outline: none;
      border-color: #c9a897;
      box-shadow: 0 0 0 3px rgba(201, 168, 151, 0.1);
    }

    textarea::placeholder {
      color: #aaa;
    }

    .send-btn {
      width: 66px;
      height: 66px;
      padding: 0;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(201, 168, 151, 0.3);
      flex-shrink: 0;
      margin-left: 5px;
      position: relative;
      z-index: 10000;
      overflow: visible;
    }

    .send-btn:hover:not(:disabled) {
      background: #b89786;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(201, 168, 151, 0.4);
    }

    .send-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-btn:focus-visible {
      outline: 3px solid #c9a897;
      outline-offset: 3px;
    }

    .send-btn svg {
      width: 30px;
      height: 30px;
    }

    .send-btn:hover:not(:disabled)::after {
      content: attr(title);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
      animation: tooltipFadeInFromBottom 0.2s ease-out;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      z-index: 10001;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      font-size: 3.5rem;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .empty-state-text {
      font-size: 1.25rem;
      margin-bottom: 10px;
      color: #666;
      font-weight: 500;
    }

    .empty-state-subtext {
      font-size: 0.938rem;
      color: #999;
    }

    /* Mobile Sidebar Backdrop */
    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 10000; /* Above all main content, below sidebar */
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-backdrop.active {
      display: block;
      opacity: 1;
    }

    /* Feedback Button in Chat Header */
    .feedback-btn {
      padding: 10px 18px;
      background: transparent;
      color: #999;
      border: 1.5px solid #e5e5e5;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s ease;
      display: none;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      white-space: nowrap;
      min-height: 44px; /* Touch-friendly */
    }

    .feedback-btn.visible {
      display: flex;
    }

    .feedback-btn:hover {
      border-color: #c9a897;
      color: #c9a897;
      background: #faf8f6;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(201, 168, 151, 0.15);
    }

    .feedback-btn:active {
      transform: scale(0.97);
    }

    .feedback-btn svg {
      flex-shrink: 0;
    }

    /* Feedback Modal Overlay */
    .feedback-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .feedback-overlay.active {
      display: flex;
      opacity: 1;
    }

    .feedback-modal {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 560px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform: translateY(20px) scale(0.97);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .feedback-overlay.active .feedback-modal {
      transform: translateY(0) scale(1);
    }

    .feedback-modal-header {
      padding: 28px 32px 0 32px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
    }

    .feedback-modal-header h2 {
      font-size: 1.35rem;
      font-weight: 600;
      color: #1a1a1a;
      letter-spacing: -0.3px;
    }

    .feedback-modal-header p {
      font-size: 0.875rem;
      color: #888;
      margin-top: 6px;
      line-height: 1.5;
    }

    .feedback-close-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      background: #f5f1ed;
      color: #999;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
      margin-left: 16px;
    }

    .feedback-close-btn:hover {
      background: #e8dfd8;
      color: #666;
      transform: rotate(90deg);
    }

    .feedback-modal-body {
      padding: 24px 32px;
      flex: 1;
      overflow-y: auto;
    }

    .feedback-textarea {
      width: 100%;
      min-height: 160px;
      max-height: 300px;
      padding: 18px 20px;
      border: 1.5px solid #e5e5e5;
      border-radius: 14px;
      font-family: inherit;
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
      color: #1a1a1a;
      background: #fafafa;
      transition: all 0.2s ease;
    }

    .feedback-textarea:focus {
      outline: none;
      border-color: #c9a897;
      background: white;
      box-shadow: 0 0 0 3px rgba(201, 168, 151, 0.12);
    }

    .feedback-textarea::placeholder {
      color: #bbb;
    }

    .feedback-modal-footer {
      padding: 0 32px 28px 32px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .feedback-cancel-btn {
      padding: 12px 24px;
      background: transparent;
      color: #888;
      border: 1.5px solid #e5e5e5;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .feedback-cancel-btn:hover {
      border-color: #ccc;
      color: #666;
    }

    .feedback-submit-btn {
      padding: 12px 28px;
      background: #c9a897;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(201, 168, 151, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feedback-submit-btn:hover:not(:disabled) {
      background: #b89786;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(201, 168, 151, 0.4);
    }

    .feedback-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Feedback Success State */
    .feedback-success {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 32px;
      text-align: center;
    }

    .feedback-success.show {
      display: flex;
    }

    .feedback-success-icon {
      width: 64px;
      height: 64px;
      background: #e8f5e9;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      animation: successPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes successPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .feedback-success-icon svg {
      color: #4caf50;
    }

    .feedback-success h3 {
      font-size: 1.2rem;
      color: #1a1a1a;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .feedback-success p {
      font-size: 0.875rem;
      color: #888;
      line-height: 1.5;
    }

    /* Mobile Responsive - Optimized for modern Android phones */
    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      .app-container {
        gap: 0;
        height: 100vh;
        height: 100dvh; /* Dynamic viewport for mobile browsers */
        max-width: 100%;
        margin: 0;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        height: 100dvh;
        z-index: 10001; /* Above backdrop (999) but below modals */
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 85%;
        max-width: 320px;
        border-radius: 0;
        box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar.collapsed {
        width: 85%;
        max-width: 320px;
      }

      .sidebar.collapsed.open {
        transform: translateX(0);
      }

      /* Hide sidebar toggle button on mobile (we use hamburger menu instead) */
      .sidebar-toggle-btn {
        display: none !important;
      }

      /* Always show sidebar content on mobile (no collapsed state) */
      .sidebar .sidebar-header h2 {
        display: block !important;
      }

      .sidebar .conversation-list {
        display: block !important;
      }

      .sidebar #expandedNewChat {
        display: block !important;
      }

      .sidebar #collapsedNewChat {
        display: none !important;
      }

      .sidebar-footer {
        display: flex !important;
      }

      .mobile-menu-btn {
        display: flex;
        margin-right: 12px;
      }

      .main-area {
        border-radius: 0;
        box-shadow: none;
      }

      .chat-header {
        padding: 20px 20px 16px 20px;
        flex-wrap: wrap;
        align-items: center;
        min-height: auto;
      }

      .chat-header-content {
        flex: 1 1 auto;
        min-width: 0;
        margin-right: 12px;
      }

      .chat-header h1 {
        font-size: 1.375rem;
        margin-bottom: 2px;
      }

      .chat-header .subtitle {
        font-size: 0.875rem;
        line-height: 1.4;
      }

      .feedback-btn {
        flex: 0 0 auto;
        padding: 10px 16px;
        min-height: 44px;
        font-size: 13px;
        white-space: nowrap;
      }

      .feedback-btn svg {
        width: 14px;
        height: 14px;
      }

      .feedback-btn:hover {
        transform: none; /* Disable hover effects on touch */
      }

      .feedback-btn:active {
        transform: scale(0.96);
      }

      .chat-history {
        padding: 20px;
      }

      .message {
        margin-bottom: 24px;
      }

      .message-role {
        font-size: 0.75rem;
        margin-bottom: 8px;
        letter-spacing: 0.5px;
      }

      .message-content {
        font-size: 15px;
        line-height: 1.65;
      }

      .message.assistant .message-content {
        padding: 18px 20px;
        border-radius: 12px;
      }

      .message-image img {
        max-width: 100%;
        border-radius: 10px;
      }

      .input-container {
        padding: 16px 20px 20px 20px;
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      }

      .input-group {
        gap: 10px;
      }

      .upload-btn, .send-btn {
        width: 56px;
        height: 56px;
        flex-shrink: 0;
      }

      .upload-btn svg, .send-btn svg {
        width: 26px;
        height: 26px;
      }

      /* Remove hover tooltips on mobile */
      .upload-btn:hover::after,
      .send-btn:hover::after {
        display: none;
      }

      textarea {
        min-height: 56px;
        max-height: 140px;
        padding: 16px 18px;
        font-size: 16px; /* Prevents zoom on focus */
        line-height: 1.5;
      }

      .feedback-modal {
        width: calc(100vw - 40px);
        max-height: calc(100vh - 100px);
        max-height: calc(100dvh - 100px);
        border-radius: 20px;
      }

      .feedback-modal-header {
        padding: 24px 20px 0 20px;
      }

      .feedback-modal-header h2 {
        font-size: 1.25rem;
      }

      .feedback-modal-header p {
        font-size: 0.875rem;
        margin-top: 8px;
      }

      .feedback-modal-body {
        padding: 20px;
      }

      .feedback-textarea {
        min-height: 160px;
        font-size: 16px; /* Prevents zoom */
        padding: 16px 18px;
        border-radius: 12px;
      }

      .feedback-modal-footer {
        padding: 0 20px 24px 20px;
        flex-direction: column;
        gap: 10px;
      }

      .feedback-cancel-btn,
      .feedback-submit-btn {
        width: 100%;
        padding: 16px 24px;
        min-height: 52px;
        justify-content: center;
        font-size: 15px;
        border-radius: 12px;
      }

      .feedback-success {
        padding: 48px 28px;
      }

      /* Improve touch targets */
      .conversation-delete-btn {
        width: 44px;
        height: 44px;
        opacity: 1;
      }

      .sidebar-toggle-btn {
        width: 48px;
        height: 48px;
      }

      .new-chat-btn {
        min-height: 52px;
        font-size: 15px;
      }

      .conversation-item {
        padding: 14px 16px;
        margin-bottom: 6px;
        border-radius: 12px;
      }

      .conversation-title {
        font-size: 15px;
      }

      .conversation-date {
        font-size: 13px;
        margin-top: 2px;
      }

      /* Sources accordion */
      .sources-accordion summary {
        font-size: 12px;
        padding: 10px 14px;
      }

      .source-tag {
        font-size: 12px;
        padding: 7px 12px;
      }

      /* Empty state */
      .empty-state {
        padding: 60px 30px;
      }

      .empty-state-icon {
        font-size: 3rem;
      }

      .empty-state-text {
        font-size: 1.125rem;
      }

      .empty-state-subtext {
        font-size: 0.938rem;
      }
    }

    /* Small phones - iPhone 12 mini, iPhone SE, small Android */
    @media (max-width: 400px) {
      .chat-header {
        padding: 16px 16px 12px 16px;
      }

      .chat-header h1 {
        font-size: 1.25rem;
      }

      .chat-header .subtitle {
        font-size: 0.813rem;
      }

      .mobile-menu-btn {
        width: 40px;
        height: 40px;
        margin-right: 8px;
      }

      .mobile-menu-btn svg {
        width: 20px;
        height: 20px;
      }

      .feedback-btn {
        padding: 8px 12px;
        min-height: 40px;
        font-size: 12px;
        gap: 6px;
      }

      .feedback-btn svg {
        width: 13px;
        height: 13px;
      }

      .chat-history {
        padding: 16px;
      }

      .message {
        margin-bottom: 20px;
      }

      .message-content {
        font-size: 14px;
      }

      .message.assistant .message-content {
        padding: 14px 16px;
      }

      .input-container {
        padding: 12px 16px 16px 16px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
      }

      .input-group {
        gap: 8px;
      }

      .upload-btn, .send-btn {
        width: 50px;
        height: 50px;
      }

      .upload-btn svg, .send-btn svg {
        width: 22px;
        height: 22px;
      }

      textarea {
        min-height: 50px;
        padding: 14px 16px;
        font-size: 16px;
      }

      .feedback-modal {
        width: calc(100vw - 32px);
        border-radius: 16px;
      }

      .feedback-modal-header {
        padding: 20px 16px 0 16px;
      }

      .feedback-modal-header h2 {
        font-size: 1.125rem;
      }

      .feedback-modal-header p {
        font-size: 0.813rem;
      }

      .feedback-close-btn {
        width: 32px;
        height: 32px;
      }

      .feedback-modal-body {
        padding: 16px;
      }

      .feedback-textarea {
        min-height: 140px;
        padding: 14px 16px;
      }

      .feedback-modal-footer {
        padding: 0 16px 20px 16px;
        gap: 8px;
      }

      .feedback-cancel-btn,
      .feedback-submit-btn {
        padding: 14px 20px;
        min-height: 48px;
        font-size: 14px;
      }

      .sidebar {
        width: 90%;
        max-width: 300px;
      }

      .sidebar-header {
        padding: 20px 16px 16px 16px;
      }

      .sidebar-header h2 {
        font-size: 1.125rem;
      }

      .conversation-item {
        padding: 12px 14px;
      }

      .conversation-title {
        font-size: 14px;
      }

      .conversation-date {
        font-size: 12px;
      }

      .source-tag {
        font-size: 11px;
        padding: 6px 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Sidebar Backdrop -->
  <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeMobileSidebar()"></div>

  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Lebensessenz</h2>
        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="Sidebar ein-/ausklappen">
          <svg id="toggleIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
      </div>
      <div style="padding: 8px; display: none;" id="collapsedNewChat" class="sidebar.collapsed">
        <button class="new-chat-btn-collapsed" onclick="newChat()" title="Neuer Chat">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </div>
      <div style="padding: 8px; display: block;" id="expandedNewChat">
        <button class="new-chat-btn" onclick="newChat()">+ Neuer Chat</button>
      </div>
      <div class="conversation-list" id="conversationList">
        <div class="empty-conversations">Keine Conversations vorhanden</div>
      </div>

      <!-- Delete All Button -->
      <div class="sidebar-footer" id="sidebarFooter" style="display: none;">
        <button class="delete-all-btn" onclick="deleteAllConversations()" title="Alle Chats l√∂schen">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          <span class="delete-all-text">Alle Chats l√∂schen</span>
        </button>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-area" id="mainArea">
      <!-- Drag & Drop Overlay -->
      <div class="drag-drop-overlay" id="dragDropOverlay">
        <div class="drag-drop-content">
          <div class="drag-drop-icon">üì∏</div>
          <div class="drag-drop-text">Bild hier ablegen</div>
          <div class="drag-drop-subtext">JPG, PNG, HEIC oder WebP</div>
        </div>
      </div>

      <div class="chat-header">
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="chat-header-content">
          <h1>Kursbot</h1>
          <p class="subtitle">Stelle deine Fragen zum Kursmaterial</p>
        </div>
        <button class="feedback-btn" id="feedbackBtn" onclick="openFeedbackModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <span>Feedback</span>
        </button>
      </div>

      <div class="chat-history" id="chatHistory">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <div class="empty-state-text">Starte eine Konversation</div>
          <div class="empty-state-subtext">Stelle eine Frage zum Kursmaterial</div>
        </div>
      </div>

      <div class="input-container">
        <div class="input-wrapper">
          <!-- Image Preview -->
          <div class="image-preview" id="imagePreview">
            <img id="previewImg" src="" alt="Preview">
            <button class="image-preview-remove" onclick="removeImage()" title="Bild entfernen">√ó</button>
          </div>

          <!-- Input Group -->
          <div class="input-group">
            <input type="file" id="imageInput" accept="image/jpeg,image/jpg,image/png,image/heic,image/webp" style="display: none;" onchange="handleImageSelect(event)">
            <button class="upload-btn" onclick="document.getElementById('imageInput').click()" title="Bild hochladen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"/>
              </svg>
            </button>
            <textarea
              id="messageInput"
              placeholder="Stelle eine Frage oder lade ein Foto hoch..."
              onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Senden">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19V5M5 12l7-7 7 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="feedback-overlay" id="feedbackOverlay" onclick="closeFeedbackOnBackdrop(event)">
    <div class="feedback-modal">
      <!-- Form State -->
      <div id="feedbackFormState">
        <div class="feedback-modal-header">
          <div>
            <h2>Feedback geben</h2>
            <p>Dein Feedback wird zusammen mit dem gesamten Chat gespeichert.</p>
          </div>
          <button class="feedback-close-btn" onclick="closeFeedbackModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="feedback-modal-body">
          <textarea class="feedback-textarea" id="feedbackText" placeholder="Was ist dir aufgefallen? Was sollte der Bot anders machen?"></textarea>
        </div>
        <div class="feedback-modal-footer">
          <button class="feedback-cancel-btn" onclick="closeFeedbackModal()">Abbrechen</button>
          <button class="feedback-submit-btn" id="feedbackSubmitBtn" onclick="submitFeedback()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
            Absenden
          </button>
        </div>
      </div>

      <!-- Success State -->
      <div class="feedback-success" id="feedbackSuccessState">
        <div class="feedback-success-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <h3>Feedback gespeichert</h3>
        <p>Chat + Feedback wurden in den Feedback-Ordner exportiert.</p>
      </div>
    </div>
  </div>

<script>
// State
let guestId = localStorage.getItem('guestId');
let conversationId = null;
let conversations = [];
let selectedImage = null;
let selectedImageDataUrl = null; // For displaying in chat

// Initialize guest ID
if (!guestId) {
  guestId = generateUUID();
  localStorage.setItem('guestId', guestId);
  console.log('Generated new guest ID:', guestId);
}

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Drag & Drop Handlers
function initDragAndDrop() {
  const mainArea = document.getElementById('mainArea');
  const overlay = document.getElementById('dragDropOverlay');
  let dragCounter = 0;

  // Prevent default drag behaviors on whole document
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    document.body.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // Highlight drop area when dragging over main area
  mainArea.addEventListener('dragenter', (e) => {
    dragCounter++;
    if (e.dataTransfer.types.includes('Files')) {
      overlay.classList.add('active');
    }
  });

  mainArea.addEventListener('dragleave', (e) => {
    dragCounter--;
    if (dragCounter === 0) {
      overlay.classList.remove('active');
    }
  });

  mainArea.addEventListener('dragover', (e) => {
    if (e.dataTransfer.types.includes('Files')) {
      e.dataTransfer.dropEffect = 'copy';
    }
  });

  mainArea.addEventListener('drop', (e) => {
    dragCounter = 0;
    overlay.classList.remove('active');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleDroppedFile(files[0]);
    }
  });
}

function handleDroppedFile(file) {
  // Validate file type
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/heic', 'image/webp'];
  if (!validTypes.includes(file.type)) {
    alert('Bitte w√§hle ein g√ºltiges Bildformat (JPG, PNG, HEIC, WebP)');
    return;
  }

  // Validate file size (10MB max)
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    alert('Bild ist zu gro√ü. Maximale Gr√∂√üe: 10MB');
    return;
  }

  selectedImage = file;

  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    selectedImageDataUrl = e.target.result;
    const previewDiv = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    previewImg.src = selectedImageDataUrl;
    previewDiv.classList.add('show');
  };
  reader.readAsDataURL(file);

  // Update placeholder and focus
  document.getElementById('messageInput').placeholder = 'Beschreibe deine Frage zum Bild...';
  document.getElementById('messageInput').focus();
}

function formatSource(source) {
  /**
   * Format source with professional module metadata display.
   *
   * New format: "Modul 1 (1.2 Fr√ºhst√ºck und richtiger Obstverzehr), Seite 3"
   * Fallback: Parse from path if metadata missing
   */

  // Use rich metadata if available
  if (source.module_label && source.submodule_id && source.submodule_label) {
    let result = source.module_label;

    // Add submodule info in parentheses
    result += ` (${source.submodule_id} ${source.submodule_label})`;

    // Add page number
    if (source.page) {
      result += `, Seite ${source.page}`;
    }

    return result;
  }

  // Fallback: Parse from path (legacy or if metadata missing)
  const path = source.path || source;
  const parts = path.split('/');
  let result = '';

  if (parts[0] && parts[0].startsWith('modul-')) {
    const modulMatch = parts[0].match(/modul-(\d+)\.(\d+)/);
    if (modulMatch) {
      result = `Modul ${modulMatch[1]} (${modulMatch[1]}.${modulMatch[2]})`;
    } else {
      const modulNum = parts[0].match(/modul-(\d+)/);
      if (modulNum) {
        result = `Modul ${modulNum[1]}`;
      }
    }
  }

  if (parts[1]) {
    const pageMatch = parts[1].match(/page-(\d+)/);
    if (pageMatch) {
      const pageNum = parseInt(pageMatch[1], 10);
      result += ` - Seite ${pageNum}`;
    }
  }

  return result || path;
}

function formatMarkdown(text) {
  // Convert Markdown to HTML with proper line breaks
  let html = text;

  // Convert ### Heading to <h3>
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');

  // Convert ## Heading to <h2>
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

  // Convert # Heading to <h1>
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Convert **bold** to <strong>
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

  // Convert double line breaks to paragraphs
  html = html.split('\n\n').map(para => {
    para = para.trim();
    if (!para) return '';
    // Don't wrap headings in <p>
    if (para.startsWith('<h')) return para;
    return '<p>' + para + '</p>';
  }).join('\n');

  return html;
}

function formatDate(isoString) {
  const date = new Date(isoString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Gerade eben';
  if (diffMins < 60) return `Vor ${diffMins}min`;
  if (diffHours < 24) return `Vor ${diffHours}h`;
  if (diffDays < 7) return `Vor ${diffDays}d`;

  return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
}

async function loadConversations() {
  try {
    const response = await fetch(`/conversations?guest_id=${guestId}`);
    const data = await response.json();
    conversations = data.conversations || [];
    renderConversationList();
  } catch (error) {
    console.error('Failed to load conversations:', error);
  }
}

function renderConversationList() {
  const listEl = document.getElementById('conversationList');
  const footerEl = document.getElementById('sidebarFooter');

  if (conversations.length === 0) {
    listEl.innerHTML = '<div class="empty-conversations">Keine Conversations vorhanden</div>';
    footerEl.style.display = 'none';
    return;
  }

  // Show delete-all button when there are conversations
  footerEl.style.display = 'block';

  listEl.innerHTML = conversations.map(conv => `
    <div class="conversation-item ${conv.id === conversationId ? 'active' : ''}"
         data-conv-id="${conv.id}">
      <div class="conversation-content" onclick="loadConversation('${conv.id}')">
        <div class="conversation-title">${escapeHtml(conv.title || 'Neue Conversation')}</div>
        <div class="conversation-date">${formatDate(conv.updated_at)}</div>
      </div>
      <button class="conversation-delete-btn"
              onclick="deleteConversation(event, '${conv.id}')"
              title="Conversation l√∂schen">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </button>
    </div>
  `).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function loadConversation(convId) {
  conversationId = convId;
  renderConversationList(); // Update active state
  updateFeedbackButton();
  closeMobileSidebar(); // Close on mobile after selection

  try {
    const response = await fetch(`/conversations/${convId}/messages?guest_id=${guestId}`);
    const data = await response.json();

    const chatHistory = document.getElementById('chatHistory');
    chatHistory.innerHTML = '';

    for (const msg of data.messages) {
      // Convert image_path to URL if present
      let imageUrl = null;
      if (msg.image_path) {
        // Extract filename from path (e.g., "storage/uploads/abc123.jpg" -> "abc123.jpg")
        const filename = msg.image_path.split('/').pop();
        imageUrl = `/uploads/${filename}`;
      }
      renderMessage(msg.role, msg.content, null, imageUrl);
    }
  } catch (error) {
    console.error('Failed to load conversation:', error);
  }
}

function showThinkingIndicator() {
  const chatHistory = document.getElementById('chatHistory');
  const emptyState = chatHistory.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }

  const thinkingDiv = document.createElement('div');
  thinkingDiv.className = 'message assistant thinking';
  thinkingDiv.id = 'thinkingIndicator';

  thinkingDiv.innerHTML = `
    <div class="message-role">Kursbot</div>
    <div class="thinking-indicator">
      <span class="thinking-text">Denkt nach</span>
      <div class="thinking-dots">
        <div class="thinking-dot"></div>
        <div class="thinking-dot"></div>
        <div class="thinking-dot"></div>
      </div>
    </div>
  `;

  chatHistory.appendChild(thinkingDiv);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function removeThinkingIndicator() {
  const thinkingIndicator = document.getElementById('thinkingIndicator');
  if (thinkingIndicator) {
    thinkingIndicator.style.opacity = '0';
    thinkingIndicator.style.transform = 'translateY(-10px)';
    setTimeout(() => thinkingIndicator.remove(), 300);
  }
}

function renderMessage(role, content, sources = null, imageUrl = null) {
  const chatHistory = document.getElementById('chatHistory');
  const emptyState = chatHistory.querySelector('.empty-state');
  if (emptyState) {
    emptyState.remove();
  }

  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;

  const roleLabel = role === 'user' ? 'Du' : 'Kursbot';
  const formattedContent = role === 'assistant' ? formatMarkdown(content) : escapeHtml(content);

  let html = `
    <div class="message-role">${roleLabel}</div>
    <div class="message-content">${formattedContent}</div>
  `;

  // Add image if provided
  if (imageUrl) {
    html += `
      <div class="message-image">
        <img src="${imageUrl}" alt="Hochgeladenes Bild" onclick="window.open('${imageUrl}', '_blank')">
      </div>
    `;
  }

  if (sources && sources.length > 0) {
    const sourceTags = sources
      .map(s => `<span class="source-tag" title="${escapeHtml(formatSource(s))}">${escapeHtml(formatSource(s))}</span>`)
      .join('');
    html += `
      <div class="sources-accordion">
        <details>
          <summary>${sources.length} Quelle${sources.length > 1 ? 'n' : ''}</summary>
          <div class="sources-container">
            ${sourceTags}
          </div>
        </details>
      </div>
    `;
  }

  messageDiv.innerHTML = html;
  chatHistory.appendChild(messageDiv);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function handleImageSelect(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Validate file type
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/heic', 'image/webp'];
  if (!validTypes.includes(file.type)) {
    alert('Bitte w√§hle ein g√ºltiges Bildformat (JPG, PNG, HEIC, WebP)');
    return;
  }

  // Validate file size (10MB max)
  const maxSize = 10 * 1024 * 1024; // 10MB
  if (file.size > maxSize) {
    alert('Bild ist zu gro√ü. Maximale Gr√∂√üe: 10MB');
    return;
  }

  selectedImage = file;

  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    selectedImageDataUrl = e.target.result;
    const previewDiv = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    previewImg.src = selectedImageDataUrl;
    previewDiv.classList.add('show');
  };
  reader.readAsDataURL(file);

  // Update placeholder
  document.getElementById('messageInput').placeholder = 'Beschreibe deine Frage zum Bild...';
}

function removeImage() {
  selectedImage = null;
  selectedImageDataUrl = null;
  document.getElementById('imageInput').value = '';
  document.getElementById('imagePreview').classList.remove('show');
  document.getElementById('messageInput').placeholder = 'Stelle eine Frage oder lade ein Foto hoch...';
}

async function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();

  if (!message && !selectedImage) return;

  const sendBtn = document.getElementById('sendBtn');
  const sendBtnText = document.getElementById('sendBtnText');

  // Disable send button (but keep input enabled for typing next message)
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<div class="spinner"></div>';

  // Store image refs and clear for next message
  const imageToSend = selectedImage;
  const imageDataUrl = selectedImageDataUrl;

  // Render user message immediately (with image if present)
  renderMessage('user', message, null, imageDataUrl);
  input.value = '';

  if (selectedImage) {
    removeImage();
  }

  // Show thinking indicator
  showThinkingIndicator();

  try {
    let response;

    if (imageToSend) {
      // Use multipart form data for image upload
      const formData = new FormData();
      formData.append('message', message || 'Was siehst du auf diesem Bild?');
      if (conversationId) formData.append('conversationId', conversationId);
      if (guestId) formData.append('guestId', guestId);
      formData.append('image', imageToSend);

      response = await fetch('/chat/image', {
        method: 'POST',
        body: formData
      });
    } else {
      // Use JSON for regular text chat
      response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          conversationId: conversationId,
          message: message,
          guestId: guestId
        })
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.detail || 'Server error');
    }

    const data = await response.json();

    // Remove thinking indicator before showing response
    removeThinkingIndicator();

    // Small delay to let the fade-out animation complete
    await new Promise(resolve => setTimeout(resolve, 350));

    // Update conversation ID if new
    if (!conversationId) {
      conversationId = data.conversationId;
      updateFeedbackButton();
      await loadConversations(); // Refresh sidebar
    }

    // Render assistant message
    renderMessage('assistant', data.answer, data.sources);

    // Refresh conversations to update timestamp
    await loadConversations();

  } catch (error) {
    console.error('Error:', error);
    removeThinkingIndicator();
    await new Promise(resolve => setTimeout(resolve, 350));
    renderMessage('assistant', 'Fehler beim Abrufen der Antwort. Bitte versuche es erneut.');
  } finally {
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>';
    input.focus();
  }
}

function toggleSidebar() {
  // Only allow on desktop (> 768px)
  if (window.innerWidth <= 768) {
    return;
  }

  const sidebar = document.getElementById('sidebar');
  const collapsedBtn = document.getElementById('collapsedNewChat');
  const expandedBtn = document.getElementById('expandedNewChat');
  const toggleIcon = document.getElementById('toggleIcon');

  sidebar.classList.toggle('collapsed');

  if (sidebar.classList.contains('collapsed')) {
    collapsedBtn.style.display = 'block';
    expandedBtn.style.display = 'none';
    // Rotate icon 180 degrees to point right
    toggleIcon.style.transform = 'rotate(180deg)';
  } else {
    collapsedBtn.style.display = 'none';
    expandedBtn.style.display = 'block';
    // Reset icon rotation to point left
    toggleIcon.style.transform = 'rotate(0deg)';
  }

  localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

async function deleteConversation(event, convId) {
  event.stopPropagation();

  const conv = conversations.find(c => c.id === convId);
  const title = conv ? conv.title : 'Conversation';

  if (!confirm(`M√∂chtest du "${title}" wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
    return;
  }

  try {
    const response = await fetch(`/conversations/${convId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ guest_id: guestId })
    });

    if (response.ok) {
      conversations = conversations.filter(c => c.id !== convId);

      if (conversationId === convId) {
        conversationId = null;
        localStorage.removeItem('conversationId');
        updateFeedbackButton();
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <div class="empty-state-text">Starte eine Konversation</div>
            <div class="empty-state-subtext">Stelle eine Frage zum Kursmaterial</div>
          </div>
        `;
      }

      renderConversationList();
    } else {
      alert('Fehler beim L√∂schen der Conversation');
    }
  } catch (error) {
    console.error('Delete failed:', error);
    alert('Fehler beim L√∂schen der Conversation');
  }
}

async function deleteAllConversations() {
  if (conversations.length === 0) {
    return;
  }

  const count = conversations.length;
  if (!confirm(`M√∂chtest du wirklich alle ${count} Conversation${count > 1 ? 's' : ''} l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
    return;
  }

  try {
    // Delete all conversations
    const deletePromises = conversations.map(conv =>
      fetch(`/conversations/${conv.id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ guest_id: guestId })
      })
    );

    const results = await Promise.all(deletePromises);

    // Check if all deletions were successful
    const allSuccess = results.every(r => r.ok);

    if (allSuccess) {
      // Clear local state
      conversations = [];
      conversationId = null;
      localStorage.removeItem('conversationId');
      updateFeedbackButton();

      // Reset chat view
      const chatHistory = document.getElementById('chatHistory');
      chatHistory.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <div class="empty-state-text">Starte eine Konversation</div>
          <div class="empty-state-subtext">Stelle eine Frage zum Kursmaterial</div>
        </div>
      `;

      renderConversationList();
    } else {
      alert('Einige Conversations konnten nicht gel√∂scht werden. Bitte versuche es erneut.');
      await loadConversations(); // Reload to get current state
    }
  } catch (error) {
    console.error('Delete all failed:', error);
    alert('Fehler beim L√∂schen der Conversations');
    await loadConversations(); // Reload to get current state
  }
}

function newChat() {
  conversationId = null;
  updateFeedbackButton();
  closeMobileSidebar(); // Close on mobile

  const chatHistory = document.getElementById('chatHistory');
  chatHistory.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">üí¨</div>
      <div class="empty-state-text">Starte eine Konversation</div>
      <div class="empty-state-subtext">Stelle eine Frage zum Kursmaterial</div>
    </div>
  `;

  renderConversationList(); // Update active state
  document.getElementById('messageInput').focus();
}

// Paste Handler for Screenshots (Cmd+V / Ctrl+V)
function initPasteHandler() {
  // Listen on the entire document for paste events
  document.addEventListener('paste', (e) => {
    const items = e.clipboardData?.items;
    if (!items) return;

    // Check if any clipboard item is an image
    for (let i = 0; i < items.length; i++) {
      const item = items[i];

      if (item.type.indexOf('image') !== -1) {
        e.preventDefault(); // Prevent default paste behavior

        const blob = item.getAsFile();
        if (blob) {
          handleDroppedFile(blob);
        }
        break;
      }
    }
  });
}

// ‚îÄ‚îÄ Mobile Sidebar Functions ‚îÄ‚îÄ

function toggleMobileSidebar() {
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('sidebarBackdrop');

  if (window.innerWidth > 768) return; // Only on mobile

  sidebar.classList.toggle('open');
  backdrop.classList.toggle('active');

  if (sidebar.classList.contains('open')) {
    document.body.style.overflow = 'hidden';
  } else {
    document.body.style.overflow = '';
  }
}

function closeMobileSidebar() {
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('sidebarBackdrop');

  sidebar.classList.remove('open');
  backdrop.classList.remove('active');
  document.body.style.overflow = '';
}

// Close mobile sidebar when window is resized to desktop
window.addEventListener('resize', () => {
  if (window.innerWidth > 768) {
    closeMobileSidebar();
  }
});

// ‚îÄ‚îÄ Feedback Functions ‚îÄ‚îÄ

function updateFeedbackButton() {
  const btn = document.getElementById('feedbackBtn');
  if (conversationId) {
    btn.classList.add('visible');
  } else {
    btn.classList.remove('visible');
  }
}

function openFeedbackModal() {
  if (!conversationId) return;

  const overlay = document.getElementById('feedbackOverlay');
  const formState = document.getElementById('feedbackFormState');
  const successState = document.getElementById('feedbackSuccessState');
  const textarea = document.getElementById('feedbackText');

  // Reset to form state
  formState.style.display = 'block';
  successState.classList.remove('show');
  textarea.value = '';

  // Prevent body scroll on mobile
  document.body.style.overflow = 'hidden';

  // Show modal with animation
  overlay.style.display = 'flex';
  requestAnimationFrame(() => {
    overlay.classList.add('active');
  });

  // Focus textarea after animation (with iOS keyboard workaround)
  setTimeout(() => {
    textarea.focus();
    // Scroll into view on mobile if keyboard appears
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    }
  }, 350);
}

function closeFeedbackModal() {
  const overlay = document.getElementById('feedbackOverlay');
  overlay.classList.remove('active');

  // Re-enable body scroll
  document.body.style.overflow = '';

  setTimeout(() => {
    overlay.style.display = 'none';
  }, 300);
}

function closeFeedbackOnBackdrop(event) {
  if (event.target === event.currentTarget) {
    closeFeedbackModal();
  }
}

async function submitFeedback() {
  const textarea = document.getElementById('feedbackText');
  const feedback = textarea.value.trim();
  if (!feedback) {
    textarea.focus();
    textarea.style.borderColor = '#ff6b6b';
    setTimeout(() => { textarea.style.borderColor = ''; }, 1500);
    return;
  }

  const submitBtn = document.getElementById('feedbackSubmitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Speichern...';

  try {
    const response = await fetch('/feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        conversationId: conversationId,
        feedback: feedback,
        guestId: guestId,
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Fehler beim Speichern');
    }

    // Show success state
    const formState = document.getElementById('feedbackFormState');
    const successState = document.getElementById('feedbackSuccessState');
    formState.style.display = 'none';
    successState.classList.add('show');

    // Auto-close after 2s
    setTimeout(() => closeFeedbackModal(), 2000);

  } catch (error) {
    console.error('Feedback error:', error);
    alert('Fehler beim Speichern: ' + error.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg> Absenden';
  }
}

// Close feedback modal with Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const overlay = document.getElementById('feedbackOverlay');
    if (overlay.classList.contains('active')) {
      closeFeedbackModal();
    }
  }
});

// Load conversations on page load
window.addEventListener('DOMContentLoaded', async () => {
  // Initialize drag and drop
  initDragAndDrop();

  // Initialize paste handler for screenshots
  initPasteHandler();

  // Restore sidebar collapse state (only on desktop)
  if (window.innerWidth > 768) {
    const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (sidebarCollapsed) {
      const sidebar = document.getElementById('sidebar');
      const collapsedBtn = document.getElementById('collapsedNewChat');
      const expandedBtn = document.getElementById('expandedNewChat');
      const toggleIcon = document.getElementById('toggleIcon');

      sidebar.classList.add('collapsed');
      collapsedBtn.style.display = 'block';
      expandedBtn.style.display = 'none';
      toggleIcon.style.transform = 'rotate(180deg)';
    }
  }

  await loadConversations();

  // Check for conversation ID in URL
  const urlParams = new URLSearchParams(window.location.search);
  const urlConvId = urlParams.get('c');
  if (urlConvId && conversations.some(c => c.id === urlConvId)) {
    await loadConversation(urlConvId);
  }

  // Update feedback button visibility on initial load
  updateFeedbackButton();

  document.getElementById('messageInput').focus();
});
</script>
</body>
</html>
